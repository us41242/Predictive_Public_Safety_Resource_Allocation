import json
import geopandas as gpd
import pandas as pd
import numpy as np
import os

# Configuration
FILES = {
    '2023': 'data/LVMPD_Calls_For_Service_2023.geojson',
    '2024': 'data/LVMPD_Calls_For_Service_2024.geojson'
}
# Output will be 'data/cleaned_lvmpd_2023.parquet' and 'data/cleaned_lvmpd_2024.parquet'
OUTPUT_TEMPLATE = 'data/cleaned_lvmpd_{year}.parquet'

def load_data(file_path):
    """Loads a GeoJSON file into a GeoDataFrame."""
    print(f"Loading data from: {file_path}...")
    try:
        if not os.path.exists(file_path):
            print(f"!!! Error: File not found: {file_path}")
            return None
        gdf = gpd.read_file(file_path)
        print(f"Data loaded. Shape: {gdf.shape}")
        return gdf
    except Exception as e:
        print(f"Error loading GeoJSON: {e}")
        return None

def clean_types(gdf):
    """Converts critical columns and handles missing coordinates."""
    print("Cleaning data types...")
    
    # Convert date/time
    gdf['IncidentDate'] = pd.to_datetime(gdf['IncidentDate'], errors='coerce')
    
    # --- TEMPORAL FIX: Drop exact midnight timestamps (likely artifacts) ---
    is_midnight = gdf['IncidentDate'].dt.time == pd.to_datetime('00:00:00').time()
    midnight_count = is_midnight.sum()
    if midnight_count > 0:
        print(f"Dropping {midnight_count} rows with default 00:00:00 timestamps...")
        gdf = gdf[~is_midnight]

    # Handle coordinates
    gdf['Latitude'] = pd.to_numeric(gdf['Latitude'], errors='coerce')
    gdf['Longitude'] = pd.to_numeric(gdf['Longitude'], errors='coerce')
    
    # Drop rows with missing critical data
    initial_rows = len(gdf)
    gdf.dropna(subset=['IncidentDate', 'Latitude', 'Longitude'], inplace=True)
    print(f"Dropped {initial_rows - len(gdf)} rows with missing critical data.")
    
    return gdf

def create_features(gdf):
    """Derives new features (Time Period, Weekend)."""
    print("Creating features...")
    
    # 1. Is it the weekend? (Fri-Sat-Sun usually behave differently)
    # Using 5 (Sat) and 6 (Sun) is standard, but you can include Fri (4) if you want.
    gdf['Is_Weekend'] = gdf['IncidentDate'].dt.dayofweek.apply(lambda x: 1 if x >= 5 else 0)
    
    # 2. Time Period Categorization
    hour = gdf['IncidentDate'].dt.hour
    bins = [0, 6, 12, 17, 23, 24] 
    labels = ['Late_Night', 'Morning', 'Afternoon', 'Evening', 'Late_Night'] 
    
    time_periods = pd.cut(hour, bins=bins, labels=labels, right=False, ordered=False)
    gdf['Time_Period'] = time_periods.astype('category')
    
    return gdf

def categorize_incidents(gdf):
    """Improved categorization logic."""
    print("Categorizing incidents...")
    descriptions = gdf['IncidentTypeDescription'].str.lower().fillna('unknown')

    def map_category(desc):
        # 1. VIOLENT CRIME
        if ('homicide' in desc or 'battery' in desc or 'assault' in desc or 
            'robbery' in desc or 'sex' in desc or 'gun' in desc or 
            'knife' in desc or 'shooting' in desc or 'shot spotter' in desc or 
            'fight' in desc or 'weapon' in desc):
            return 'Violent_Crime'
        # 2. DOMESTIC
        elif 'domestic' in desc or 'family' in desc:
            return 'Domestic_Dispute'
        # 3. DISTURBANCE
        elif 'disturbance' in desc or 'keep the peace' in desc or 'noise' in desc or 'nuisance' in desc:
            return 'Public_Disturbance'
        # 4. PROPERTY
        elif ('burglary' in desc or 'theft' in desc or 'shoplift' in desc or 
              'larceny' in desc or 'stolen' in desc or 'property' in desc):
            return 'Property_Crime'
        # 5. TRAFFIC
        elif ('accident' in desc or 'crash' in desc or 'd.u.i.' in desc or 
              'traffic' in desc or 'vehicle' in desc or 'hit and run' in desc or 
              'drunk' in desc or 'reckless' in desc):
            return 'Traffic_Incident'
        # 6. VANDALISM
        elif 'vandalism' in desc or 'graffiti' in desc or 'damage' in desc or 'destruct' in desc:
            return 'Vandalism'
        # 7. PUBLIC SERVICE
        elif ('assist' in desc or 'civil' in desc or 'missing' in desc or 
              'runaway' in desc or 'found' in desc or 'dead body' in desc or 
              'welfare' in desc):
            return 'Public_Service'
        # 8. SUSPICIOUS
        elif 'check' in desc or 'suspicious' in desc or 'trespassing' in desc or 'wanted' in desc:
            return 'Suspicious_Activity'
        # 9. OTHER
        elif 'fraud' in desc or 'forgery' in desc:
            return 'Fraud'
        elif 'narcotics' in desc or 'drug' in desc:
            return 'Drug_Offense'
        elif 'fire' in desc:
            return 'Fire'
        else:
            return 'Miscellaneous'

    gdf['Crime_Category'] = descriptions.apply(map_category)
    return gdf

if __name__ == '__main__':
    for year, file_path in FILES.items():
        print(f"\n--- Processing {year} Data ---")
        
        # 1. Load
        gdf = load_data(file_path)
        
        if gdf is not None:
            # 2. Clean
            gdf = clean_types(gdf)
            # 3. Feature Engineering
            gdf = create_features(gdf)
            # 4. Categorize
            gdf = categorize_incidents(gdf)
            
            # 5. Save
            output_path = OUTPUT_TEMPLATE.format(year=year)
            print(f"Saving {year} data to: {output_path}")
            try:
                gdf.to_parquet(output_path)
                print(f"Success! {year} data ready.")
            except Exception as e:
                print(f"Error saving parquet: {e}")

